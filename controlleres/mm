const Stock = require('../models/stock');
const Product = require('../models/product');

exports.listStocks = async (req, res) => {
  try {
    const stocks = await Stock.find()
      .populate('product') 
      .sort({ createdAt: -1 });

    const products = await Product.find(); // For dropdown

    res.render('stock', { stocks, products });
  } catch (err) {
    console.error('Error fetching stock:', err);
    res.status(500).send('Internal Server Error');
  }
};

exports.showAddForm = async (req, res) => {
  const products = await Product.find();
  const stocks=await Stock.find()
  res.render('stock', { products,stocks });

};

exports.addStock = async (req, res) => {
  const { product, quantity } = req.body;
  await Stock.create({
    product,
    quantity,
    addedBy: new mongoose.Types.ObjectId(req.user._id),
  });
  res.redirect('/admin/stock');
};

exports.editStockForm = async (req, res) => {
  const stock = await Stock.findById(req.params.id);
  const products = await Product.find();
  res.render('stock', { stock, products });
};

exports.updateStock = async (req, res) => {
  const { product, quantity } = req.body;
  await Stock.findByIdAndUpdate(req.params.id, { product, quantity });
  res.redirect('/admin/stock');
};

exports.deleteStock = async (req, res) => {
  await Stock.findByIdAndDelete(req.params.id);
  res.redirect('/admin/stock');
};
